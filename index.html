<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Alata&display=swap" rel="stylesheet">

    <!-- Compiled and minified CSS Materialize -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!-- Compiled and minified JavaScript Materialize-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <!-- Custom Style Sheet -->
    <link rel="stylesheet" href="css/styletest.css">

    <!-- JQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Google Maps API -->
    <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBI0JkCmRsmKDi_N_SPzDdFfOUizXZdd-Q&callback=initMap"></script>

</head>

<body>
    <h3>Best Restaurant Finder</h3>
    <!--The div element for the map -->

    <div class="container">
        <div class="row">
            <form class="col s12">
                <div class="rown">
                    <div class="input-field col s4">
                        <input placeholder="Austin" id="city_name" type="text" class="validate">
                        <label for="city_name">City Name</label>
                    </div>
                    <div class="input-field col s4">
                        <input placeholder="Chinese Food" id="query_word" type="text" class="validate">
                        <label for="query_word">Main Category</label>
                    </div>
                    <div class="input-field col s4">
                        <input placeholder="Chinese, Oriental, Traditional" id="cuisines" type="text" class="validate">
                        <label for="cuisines">Cuisines</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s4">
                        <input placeholder="Restaurant, Take Out" id="type" type="text" class="validate">
                        <label for="type">Type</label>
                    </div>
                    <div class="input-field col s4">
                        <input placeholder="10" id="restaurant_count" type="number" class="validate">
                        <label for="restaurant_count">Restaurant Count</label>
                    </div>
                    <div class="input-field col s4">
                        <input placeholder="10" id="distance" type="number" class="validate">
                        <label for="distance">Distance(Miles)</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12">
                        <button class="waves-effect waves-light btn-small deep-purple lighten-1" type="button" id="btn-search">Search!</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="row">
            <table class="col s6 center-align responsive-table" id="info-rest">
                <tbody id="food-list"></tbody>
            </table>
            <div class="col s6 center-align" id="map"></div>
        </div>
    </div>

</body>


<script>
    var map, infoWindow;

    var lastRestaurantSearch;
    var mapMarkers = [];
    var lastCitySearch = "Austin";
    var lastEntityId = 0;
    var lastPos = {
        lat: 30.266748,
        lng: -97.74176
    };

    const zomatoApiKey = "f0ebb130a10a55db4fc869102e19af66";

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: {
                lat: lastPos.lat,
                lng: lastPos.lng
            },
            zoom: 10
        });

        createUserMarker();

        infoWindow = new google.maps.InfoWindow;
    }

    function createUserMarker() {
        var userPosition = new google.maps.Marker({
            position: lastPos,
            map: map,
            icon: "assets/user-marker.png",
            title: "You!",
        })

        userPosition.setZIndex(100);

        // mapMarkers.push(userPosition);
    }

    $(document).ready(function() {

        initialize();

        function initialize() {

            getRestaurantInfo("Austin");

            $("#btn-search").on("click ", function(event) {
                event.preventDefault();

                // // Try HTML5 geolocation.
                // if (navigator.geolocation) {
                //     navigator.geolocation.getCurrentPosition(function(position) {

                //         var pos = {
                //             lat: position.coords.latitude,
                //             lng: position.coords.longitude
                //         };

                //         console.log("Getting User GeoLocation " + pos);

                //         infoWindow.setPosition(pos);
                //         infoWindow.setContent('Location found.');
                //         infoWindow.open(map);
                //         map.setCenter(pos);
                //     }, function() {
                //         handleLocationError(true, infoWindow, map.getCenter());
                //     });
                // } else {
                //     // Browser doesn't support Geolocation
                //     handleLocationError(false, infoWindow, map.getCenter());
                // }

                // function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                //     infoWindow.setPosition(pos);
                //     infoWindow.setContent(browserHasGeolocation ?
                //         'Error: The Geolocation service failed.' :
                //         'Error: Your browser doesn\'t support geolocation.');
                //     infoWindow.open(map);
                // }

                getRestaurantInfo("Austin");
            });
        }

        function getRestaurantInfo(cityName) {

            var parsedCityName = encodeURIComponent(cityName);

            var queryURL = `https://developers.zomato.com/api/v2.1/locations?query=${parsedCityName}`

            $.ajax({
                method: "GET",
                crossDomain: true,
                url: queryURL,
                dataType: "json",
                async: true,
                headers: {
                    "user-key": zomatoApiKey
                }
            }).then(function(response) {

                clearMarkers();

                var mainSuggestion = response.location_suggestions[0];

                lastPos = {
                    lat: mainSuggestion.latitude,
                    lng: mainSuggestion.longitude
                };

                lastEntityId = mainSuggestion.entity_id;

                createUserMarker();

                map.setCenter(lastPos);

                getPopularRestaurants();
            });
        }

        function getPopularRestaurants() {

            // TODO Add Keyworkd from UI
            var queryWord = encodeURIComponent("chinese food");
            var radius = encodeURIComponent(1000);
            var cuisines = encodeURIComponent("chinese,oriental,traditional");
            var establishment_type = encodeURIComponent("restaurant,fast food");
            var count = 10;

            var queryURL = `https://developers.zomato.com/api/v2.1/search?entity_id=${lastEntityId}&count=${count}&entity_type=city&q=${queryWord}&radius=${radius}&cuisines=${cuisines}&establishment_type=${establishment_type}&sort=rating&order=desc`;

            $.ajax({
                method: "GET",
                crossDomain: true,
                url: queryURL,
                dataType: "json",
                async: true,
                headers: {
                    "user-key": zomatoApiKey
                }
            }).then(function(response) {
                lastRestaurantSearch = response.restaurants;

                createRestaurantList();
                createRestaurantMarkers();
            });
        }

        function createRestaurantMarkers() {
            for (var i = 0; i < lastRestaurantSearch.length; i++) {

                var restaurant = lastRestaurantSearch[i].restaurant;

                var foodLocation = restaurant.location;

                var foodPos = {
                    lat: parseFloat(foodLocation.latitude),
                    lng: parseFloat(foodLocation.longitude)
                };

                var foodMarker = new google.maps.Marker({
                    position: foodPos,
                    map: map,
                    animation: google.maps.Animation.DROP,
                    title : restaurant.name
                });

                foodMarker.addListener("click", function(event) {
                    createRestaurantInfo(restaurant);
                });

                mapMarkers.push(foodMarker);
            }
        }

        function createRestaurantList() {

            if (!lastRestaurantSearch) {
                return;
            }

            // List of all restaurants
            var foodListElem = $("#food-list");

            $(foodListElem).empty();

            for (var i = 0; i < lastRestaurantSearch.length; i++) {

                console.log(lastRestaurantSearch[i]);

                var restaurant = lastRestaurantSearch[i].restaurant;

                var cardElement = $("<tr>");

                $(cardElement).addClass("card");

                var cardImage = $("<div>");

                $(cardImage).addClass("card-image");

                var image = $("<img>");

                $(image).addClass("thumbnail");

                var thumbNail = restaurant.thumb;

                if(!thumbNail)
                    thumbNail = "assets/user-marker.png";

                $(image).attr("src", thumbNail);
                $(image).attr("alt", `thumb-for-${restaurant.name}`);

                var titleElement = $("<h6>");

                $(titleElement).addClass("card-title");

                $(titleElement).text(restaurant.name);

                $(cardImage).append(image, titleElement);

                var stackElement = $("<div>");

                $(stackElement).addClass("card-stacked");

                var addressElement = $("<p>");

                $(addressElement).text(restaurant.location.address);

                var actionElement = $("<div>");

                $(actionElement).addClass("card-action");

                var linkElement = $("<a>");

                $(linkElement).attr("href", restaurant.url);

                $(linkElement).attr("target", "_blank");

                $(linkElement).text("Visit!");

                $(actionElement).append(linkElement);

                $(stackElement).append(addressElement, actionElement);

                $(cardElement).append(cardImage, stackElement);

                $(foodListElem).append(cardElement);
            }
        }

        function createRestaurantInfo(restaurant) {
            // TODO FILL UI WITH THIS STUFF???? MAYBE
        }

        function clearMarkers() {
            for (var i = 0; i < mapMarkers.length; i++) {
                mapMarkers[i].setMap(null);
            }

            mapMarkers = [];
        }

    });
</script>

</html>