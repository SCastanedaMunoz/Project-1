<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Alata&display=swap" rel="stylesheet">

    <!-- Compiled and minified CSS Materialize -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!-- Compiled and minified JavaScript Materialize-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <!-- Custom Style Sheet -->
    <link rel="stylesheet" href="css/styletest.css">

    <!-- JQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Google Maps API -->
    <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBI0JkCmRsmKDi_N_SPzDdFfOUizXZdd-Q&callback=initMap"></script>

</head>

<body>
    <h3>Best Restaurant Finder</h3>
    <!--The div element for the map -->

    <div class="container">
        <div class="row">
            <div class="col s6 center-align" id="info-rest">

            </div>
            <div class="col s6 center-align" id="map"></div>
        </div>

        <button class="waves-effect waves-light btn-small deep-purple lighten-1" type="button" id="btn-locate">Locate Me!</button>
    </div>

</body>


<script>
    var map, infoWindow;

    var lastCitySearch = "Austin";
    var lastEntityId = 0;
    var lastPos = {
        lat: 30.266748,
        lng: -97.74176
    };

    const zomatoApiKey = "f0ebb130a10a55db4fc869102e19af66";

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: {
                lat: lastPos.lat,
                lng: lastPos.lng
            },
            zoom: 10
        });

        createUserMarker();

        infoWindow = new google.maps.InfoWindow;
    }

    function createUserMarker() {
        var userPosition = new google.maps.Marker({
            position: lastPos,
            map: map,
            icon: "assets/user-marker.png"
        })
    }

    $(document).ready(function() {

        initialize();

        function initialize() {

            $("#btn-locate").on("click ", function(event) {
                event.preventDefault();

                // // Try HTML5 geolocation.
                // if (navigator.geolocation) {
                //     navigator.geolocation.getCurrentPosition(function(position) {

                //         var pos = {
                //             lat: position.coords.latitude,
                //             lng: position.coords.longitude
                //         };

                //         console.log("Getting User GeoLocation " + pos);

                //         infoWindow.setPosition(pos);
                //         infoWindow.setContent('Location found.');
                //         infoWindow.open(map);
                //         map.setCenter(pos);
                //     }, function() {
                //         handleLocationError(true, infoWindow, map.getCenter());
                //     });
                // } else {
                //     // Browser doesn't support Geolocation
                //     handleLocationError(false, infoWindow, map.getCenter());
                // }

                // function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                //     infoWindow.setPosition(pos);
                //     infoWindow.setContent(browserHasGeolocation ?
                //         'Error: The Geolocation service failed.' :
                //         'Error: Your browser doesn\'t support geolocation.');
                //     infoWindow.open(map);
                // }

                getRestaurantInfo("New York City");
            });
        }

        function getRestaurantInfo(cityName) {

            var parsedCityName = encodeURIComponent(cityName);

            var queryURL = `https://developers.zomato.com/api/v2.1/locations?query=${parsedCityName}`

            $.ajax({
                method: "GET",
                crossDomain: true,
                url: queryURL,
                dataType: "json",
                async: true,
                headers: {
                    "user-key": zomatoApiKey
                }
            }).then(function(response) {

                var mainSuggestion = response.location_suggestions[0];

                lastPos = {
                    lat: mainSuggestion.latitude,
                    lng: mainSuggestion.longitude
                };

                lastEntityId = mainSuggestion.entity_id;

                createUserMarker();

                map.setCenter(lastPos);

                getPopularRestaurants();
            });
        }

        function getPopularRestaurants() {

            // TODO Add Keyworkd from UI
            var queryWord = encodeURIComponent("chinese food");
            var radius = encodeURIComponent(1000);
            var cuisines = encodeURIComponent("chinese,oriental,traditional");
            var establishment_type = encodeURIComponent("restaurant,fast food");

            var queryURL = `https://developers.zomato.com/api/v2.1/search?entity_id=${lastEntityId}&entity_type=city&q=${queryWord}&radius=${radius}&cuisines=${cuisines}&establishment_type=${establishment_type}&sort=rating&order=desc`;

            $.ajax({
                method: "GET",
                crossDomain: true,
                url: queryURL,
                dataType: "json",
                async: true,
                headers: {
                    "user-key": zomatoApiKey
                }
            }).then(function(response) {
                console.log(response);
            });
        }

    });
</script>

</html>